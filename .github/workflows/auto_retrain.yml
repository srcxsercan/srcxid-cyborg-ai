name: Automatic Retraining on Drift Detection

on:
  schedule:
    # Run drift detection daily at 2 AM UTC
    - cron: '0 2 * * *'
  
  workflow_dispatch:
    inputs:
      force_retrain:
        description: 'Force retraining even if no drift detected'
        required: false
        type: boolean
        default: false

jobs:
  detect-drift:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write  # For artifact upload/download
    outputs:
      drift_detected: ${{ steps.drift.outputs.drift_detected }}
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install numpy

      - name: Download previous snapshot
        id: download_previous
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          name: dataset-snapshot-previous
          path: snapshots/

      - name: Create or download current snapshot
        id: current_snapshot
        run: |
          mkdir -p snapshots
          # In real scenario, generate snapshot from current data
          # For now, create dummy snapshots
          python scripts/detect_drift.py \
            --current snapshots/current.json \
            --previous snapshots/previous.json \
            --output drift_report.json \
            --create-dummy

      - name: Run drift detection
        id: drift
        run: |
          # Run drift detection
          if python scripts/detect_drift.py \
            --current snapshots/current.json \
            --previous snapshots/previous.json \
            --output drift_report.json \
            --kl-threshold 0.1 \
            --mean-threshold 0.15 \
            --std-threshold 0.20; then
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "No drift detected"
          else
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 2 ]; then
              echo "drift_detected=true" >> $GITHUB_OUTPUT
              echo "Drift detected - will trigger retraining"
            else
              echo "Error in drift detection"
              exit 1
            fi
          fi

      - name: Upload drift report
        uses: actions/upload-artifact@v4
        with:
          name: drift-report-${{ github.run_id }}
          path: drift_report.json
          retention-days: 90

      - name: Save current as previous snapshot
        uses: actions/upload-artifact@v4
        with:
          name: dataset-snapshot-previous
          path: snapshots/current.json
          retention-days: 30

      - name: Notify drift detection
        if: steps.drift.outputs.drift_detected == 'true'
        run: |
          echo "### ðŸš¨ Data Drift Detected" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Drift has been detected in the dataset." >> $GITHUB_STEP_SUMMARY
          echo "Automatic retraining will be triggered." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Drift Report:** See artifacts for details" >> $GITHUB_STEP_SUMMARY

      - name: Check Slack configuration
        id: check_slack
        if: steps.drift.outputs.drift_detected == 'true'
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            echo "slack_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "slack_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Send Slack notification (if configured)
        if: steps.check_slack.outputs.slack_enabled == 'true'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "ðŸš¨ Data Drift Detected in SRCX Blueprint AI",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Data Drift Detected*\nAutomatic retraining will be triggered.\nCheck GitHub Actions for details."
                  }
                }
              ]
            }'

  retrain:
    needs: detect-drift
    if: needs.detect-drift.outputs.drift_detected == 'true' || github.event.inputs.force_retrain == 'true'
    permissions:
      contents: read
      actions: write
    uses: ./.github/workflows/reusable/train-reusable.yml
    with:
      data_path: 'data/training'
      epochs: 15
      use_mlflow: true
      model_out_dir: 'models/retrained'
      batch_size: 32
      learning_rate: 0.001
    secrets:
      MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
      S3_BUCKET: ${{ secrets.S3_BUCKET }}

  notify-completion:
    needs: [detect-drift, retrain]
    if: always() && needs.retrain.result == 'success'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Training completion summary
        run: |
          echo "### âœ… Automatic Retraining Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Model has been retrained successfully." >> $GITHUB_STEP_SUMMARY
          echo "New model artifacts are available in the workflow artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Check Slack configuration
        id: check_slack
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK }}" ]; then
            echo "slack_enabled=true" >> $GITHUB_OUTPUT
          else
            echo "slack_enabled=false" >> $GITHUB_OUTPUT
          fi

      - name: Send success notification (if configured)
        if: steps.check_slack.outputs.slack_enabled == 'true'
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "âœ… SRCX Blueprint AI Retraining Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Retraining Completed Successfully*\nNew model is ready for deployment."
                  }
                }
              ]
            }'
